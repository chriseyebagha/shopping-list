<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping List</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f8;
      color: #1a1d24;
      padding: 24px 16px 72px;
      min-height: 100vh;
    }

    .header {
      max-width: 660px;
      margin: 0 auto 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: #1a1d24;
      line-height: 1.3;
      margin-bottom: 6px;
    }

    .header h1 .highlight {
      color: #d4850f;
    }

    .header p {
      font-size: 0.88rem;
      color: #5a6070;
      line-height: 1.5;
    }

    /* Add item section */
    .add-item-section {
      max-width: 660px;
      margin: 0 auto 16px;
      background: #ffffff;
      border: 2px solid #d4850f;
      border-radius: 12px;
      padding: 16px;
    }

    .add-item-section h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1a1d24;
      margin-bottom: 12px;
    }

    .add-item-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .add-item-row {
      display: flex;
      gap: 8px;
    }

    .add-item-form input,
    .add-item-form select {
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      padding: 10px 12px;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      background: #f9fafb;
    }

    .add-item-form input {
      flex: 1;
    }

    .add-item-form select {
      min-width: 130px;
    }

    .add-item-form input:focus,
    .add-item-form select:focus {
      outline: none;
      border-color: #d4850f;
      background: #fff;
    }

    .add-item-form button {
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      font-weight: 600;
      padding: 10px 20px;
      background: #d4850f;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    .add-item-form button:active {
      transform: scale(0.98);
    }

    /* Active list section */
    .active-list {
      max-width: 660px;
      margin: 0 auto 32px;
    }

    .active-list-empty {
      background: #ffffff;
      border: 1px solid #e4e7ed;
      border-radius: 12px;
      padding: 40px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9a9fad;
      font-size: 0.88rem;
      font-style: italic;
      text-align: center;
    }

    .store-group {
      background: #ffffff;
      border: 1px solid #e4e7ed;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .store-group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f2f5;
    }

    .store-group-icon {
      width: 36px;
      height: 36px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .store-group-name {
      font-size: 1rem;
      font-weight: 700;
      color: #1a1d24;
    }

    .divider {
      max-width: 660px;
      margin: 40px auto;
      text-align: center;
      position: relative;
    }

    .divider::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
      background: #e0e3e8;
    }

    .divider span {
      position: relative;
      background: #f4f6f8;
      padding: 0 16px;
      font-size: 0.82rem;
      font-weight: 600;
      color: #7a8290;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .store-section {
      max-width: 660px;
      margin: 0 auto 28px;
    }

    .store-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e3e8;
    }

    .store-icon {
      width: 42px;
      height: 42px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    /* Updated store colors */
    .store-icon.pending {
      background: #ef4444;
    }

    .store-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1a1d24;
    }

    .store-header .item-count {
      font-size: 0.78rem;
      color: #7a8290;
      margin-top: 2px;
    }

    .item {
      background: #ffffff;
      border: 1px solid #e4e7ed;
      border-radius: 12px;
      padding: 14px 14px;
      /* margin-bottom removed for grid, handled by gap */
      display: flex;
      gap: 12px;
      align-items: center;
      transition: all 0.15s;
    }

    /* Active items still need margin bottom since they aren't in a grid yet, or strictly vertical */
    .active-item {
      margin-bottom: 8px;
    }

    .item:hover {
      border-color: #c0c4cc;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
    }

    .item.active-item {
      background: #fffbf0;
      border-color: #f0d88a;
    }

    /* Hide default checkbox */
    .item input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    /* Custom checkbox */
    .checkmark {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid #c8ccd5;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      transition: all 0.2s;
    }

    .checkmark svg {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .item input[type="checkbox"]:checked~.checkmark {
      background: #22c55e;
      border-color: #22c55e;
    }

    .item input[type="checkbox"]:checked~.checkmark svg {
      opacity: 1;
    }

    .item input[type="checkbox"]:checked~.item-label {
      text-decoration: line-through;
      color: #9a9fad;
    }

    .item input[type="checkbox"]:checked~.item-label,
    .item input[type="checkbox"]:checked~.checkmark {
      opacity: 0.4;
    }

    .item-label {
      font-size: 0.95rem;
      font-weight: 500;
      color: #1a1d24;
      line-height: 1.4;
      flex: 1;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .item label {
      display: flex;
      gap: 12px;
      align-items: center;
      cursor: pointer;
      flex: 1;
    }

    .delete-btn {
      background: #fee;
      border: 1px solid #fcc;
      color: #c00;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
    }

    .delete-btn:active {
      transform: scale(0.95);
    }

    .action-buttons {
      max-width: 660px;
      margin: 20px auto 0;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .action-buttons button {
      background: #ffffff;
      border: 1px solid #e4e7ed;
      border-radius: 10px;
      padding: 12px 24px;
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      font-weight: 600;
      color: #5a6070;
      cursor: pointer;
    }

    .action-buttons button.danger {
      color: #ef4444;
    }

    .action-buttons button:active {
      transform: scale(0.98);
    }

    .suggestion-item {
      opacity: 0.9;
      opacity: 0.9;
      cursor: pointer;
      justify-content: space-between;
      /* Push icon to the right */
      padding-right: 12px;
    }

    .suggestion-item:active {
      transform: scale(0.98);
      background: #f0f9ff;
      border-color: #3b82f6;
    }

    .suggestion-icon {
      /* New minimal design: No background, subtle color, right aligned */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-left: 8px;
      margin-right: 0;
      color: #9ca3af;
      font-size: 18px;
      font-weight: 300;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    /* LOGIN OVERLAY */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f4f6f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .login-box {
      background: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      text-align: center;
      max-width: 90%;
      width: 360px;
    }
    .login-btn {
      background: #4285F4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-top: 20px;
      transition: background 0.2s;
    }
    .login-btn:hover { background: #357ae8; }
    
    /* USER HEADER */
    .user-header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 20px;
      max-width: 660px;
      margin-left: auto;
      margin-right: auto;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #5a6070;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e3e8;
    }
    .logout-btn {
      font-size: 0.8rem;
      color: #ef4444;
      background: none;
      border: 1px solid #ef4444;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
    }


    .item-label {
      font-size: 0.95rem;
      font-weight: 500;
      color: #1a1d24;
      line-height: 1.35;
      flex: 1;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      word-wrap: break-word;
      /* Ensure different browsers handle long words */
      overflow-wrap: break-word;
    }

    .suggestion-item:hover .suggestion-icon {
      color: #d4850f;
      /* Brand color on hover */
      transform: scale(1.1);
      /* Slight grow instead of rotate */
      background: transparent;
    }

    /* Active List Grid Layout */
    .active-items-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      width: 100%;
      /* Force full width */
    }

    @media (min-width: 320px) {
      .active-items-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* Update styling for active items in grid */
    .active-item {
      margin-bottom: 0;
      /* Removing margin as grid gap handles spacing */
      height: 100%;
      /* Ensure equal height */
    }

    /* GRID LAYOUT FOR SUGGESTIONS */
    .suggestions-grid {
      display: grid;
      grid-template-columns: 1fr;
      /* Default mobile 1 column if very small, but standard mobile usually fits 2 */
      gap: 8px;
    }

    @media (min-width: 380px) {
      .suggestions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 600px) {
      .suggestions-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
    }
  </style>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update, off } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // TODO: Replace with your project's config object
    // You can find this in Firebase Console -> Project Settings -> General -> Your apps
    const firebaseConfig = {
      apiKey: "AIzaSyBAnMbbd7hbQvx8mdNF5PajAdxl_VYOsxE",
      authDomain: "chris-shopping-list.firebaseapp.com",
      databaseURL: "https://chris-shopping-list-default-rtdb.firebaseio.com",
      projectId: "chris-shopping-list",
      storageBucket: "chris-shopping-list.firebasestorage.app",
      messagingSenderId: "222533323145",
      appId: "1:222533323145:web:f24d42c4dccd0fa19fb958",
      measurementId: "G-V3DT5PCT0D"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // References (Dynamic based on User)
    let listRef;
    let suggestionsRef;
    let iconsRef;
    let currentUser = null;

    // --- INITIAL DATA SEEDING ---
    const INITIAL_SEED_DATA = [
      // ... (Keep existing seed data for backup/init)
      // General / Home
      { name: 'Plates', store: 'General', count: 5 },
      { name: 'Spoons', store: 'General', count: 5 },
      { name: 'Wine glass', store: 'General', count: 3 },
      { name: 'Trash bags', store: 'General', count: 10 },
      { name: 'Trash bin', store: 'General', count: 2 },
      { name: 'Cups', store: 'General', count: 5 },
      { name: 'Rain Jacket', store: 'General', count: 1 },
      // Costco
      { name: 'Toilet paper', store: 'Costco', count: 20 },
      { name: 'Paper towels', store: 'Costco', count: 18 },
      { name: 'Kitchen napkin', store: 'Costco', count: 12 },
      { name: 'Coconut Water', store: 'Costco', count: 15 },
      { name: 'Celsius', store: 'Costco', count: 12 },
      { name: 'Kirkland Grilled Chicken Breast Skewers', store: 'Costco', count: 15 },
      { name: 'Kirkland Wild Alaskan Sockeye Salmon', store: 'Costco', count: 12 },
      { name: 'Kahiki Chicken Rice Bowls ‚Äî Teriyaki', store: 'Costco', count: 8 },
      { name: 'Kirkland Rotisserie Chicken', store: 'Costco', count: 25 },
      { name: 'Bibigo Beef Pho Steamed Dumplings', store: 'Costco', count: 10 },
      { name: 'Kirkland Boneless Chicken Breasts (frozen)', store: 'Costco', count: 10 },
      // Trader Joe's
      { name: 'Eggs', store: "Trader Joe's", count: 30 },
      { name: 'Butter', store: "Trader Joe's", count: 15 },
      { name: 'Olive oil', store: "Trader Joe's", count: 8 },
      { name: 'Salt & Pepper', store: "Trader Joe's", count: 5 },
      { name: 'Branzino Fish', store: "Trader Joe's", count: 10 },
      { name: 'Tikka Masala', store: "Trader Joe's", count: 12 },
      { name: 'Argentinian Red Shrimp ‚Äî Ginger Garlic Butter', store: "Trader Joe's", count: 10 },
      { name: 'Wild Raw Argentinian Red Shrimp (1 lb bag)', store: "Trader Joe's", count: 10 },
      { name: 'Pulled Chicken Salsa Verde', store: "Trader Joe's", count: 12 },
      { name: 'Pre-Cooked Grilled Chicken Strips', store: "Trader Joe's", count: 12 },
      { name: 'Bacon Cheddar Egg Bites', store: "Trader Joe's", count: 14 }
    ];

    // --- APP STATE ---
    // Exposed to window for UI calls, but managed by Firebase listeners
    window.activeList = [];
    window.suggestionDB = {};

    // Store icon mapping - simplified
    window.storeIcons = {
      'TJ Maxx': { emoji: 'üè¨', color: '#991b1b' },
      'Costco': { emoji: 'üõí', color: '#003087' },
      "Trader Joe's": { emoji: 'üõí', color: '#c1272d' },
      'Target': { emoji: 'üéØ', color: '#cc0000' },
      'Whole Foods': { emoji: 'ü•¨', color: '#00674f' },
      'Safeway': { emoji: 'üõí', color: '#e31837' },
      'Amazon': { emoji: 'üì¶', color: '#ff9900' },
      'IKEA': { emoji: 'ü™ë', color: '#0058a3' },
      'General': { emoji: 'üè†', color: '#f97316' }
    };

    window.getStoreIcon = function (storeName) {
      if (window.storeIcons[storeName]) return window.storeIcons[storeName];
      return { emoji: 'üõçÔ∏è', color: '#6b7280' };
    };

    // --- AUTH LOGIC ---
    window.login = () => {
      signInWithPopup(auth, provider)
        .then((result) => {
          // User signed in
          console.log("User signed in:", result.user);
        }).catch((error) => {
          console.error("Login failed", error);
          alert("Login failed: " + error.message);
        });
    };

    window.logout = () => {
      signOut(auth).then(() => {
        console.log("User signed out");
        location.reload(); // Refresh to clear state cleanly
      }).catch((error) => {
        console.error("Logout failed", error);
      });
    };

    onAuthStateChanged(auth, (user) => {
      const overlay = document.getElementById('loginOverlay');
      const userHeader = document.getElementById('userHeader');
      
      if (user) {
        currentUser = user;
        // 1. Hide Overlay
        if(overlay) overlay.style.display = 'none';
        
        // 2. Show User info
        if(userHeader) {
          userHeader.style.display = 'flex';
          userHeader.innerHTML = `
            <div class="user-info">
              <img src="${user.photoURL}" class="user-avatar" alt="Avatar" />
              <span>${user.displayName.split(' ')[0]}'s List</span>
            </div>
            <button class="logout-btn" onclick="logout()">Sign Out</button>
          `;
        }

        // 3. Set References to Private Paths
        listRef = ref(db, `users/${user.uid}/shoppingList`);
        suggestionsRef = ref(db, `users/${user.uid}/suggestions`);
        iconsRef = ref(db, `users/${user.uid}/storeIcons`);

        // 4. Attach Listeners
        setupListeners();
      } else {
        // No user
        currentUser = null;
        if(overlay) overlay.style.display = 'flex';
        if(userHeader) userHeader.style.display = 'none';
      }
    });

    // --- SYNC LOGIC ---

    function setupListeners() {
      // 1. Listen for Active List Changes
      onValue(listRef, (snapshot) => {
        const data = snapshot.val();
        window.activeList = [];
        if (data) {
          // Convert object {key: val} to array [{id: key, ...val}]
          Object.entries(data).forEach(([key, val]) => {
            window.activeList.push({ id: key, ...val });
          });
        }
        renderActiveList();
      });

      // 2. Listen for Suggestions Changes
      onValue(suggestionsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.suggestionDB = data;
        } else {
          // Seed if empty (first run on new project)
          seedDatabase();
        }
        renderSuggestions();
      });

      // 3. Listen for Icon Changes (optional)
      onValue(iconsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.storeIcons = { ...window.storeIcons, ...data };
        }
        renderAll();
      });
    }


    // --- MIGRATION / SEEDING ---
    function seedDatabase() {
      // Check if we have local data to migrate first?
      const savedDB = localStorage.getItem('shoppingListSuggestionsDB');
      if (savedDB) {
        try {
          const localDB = JSON.parse(savedDB);
          update(suggestionsRef, localDB);
          console.log("Migrated local suggestions to Cloud");
        } catch (e) { console.error("Migration failed", e); }
      } else {
        // Use seed data
        const updates = {};
        INITIAL_SEED_DATA.forEach(item => {
          updates[item.name] = {
            store: item.store,
            count: item.count,
            lastUsed: Date.now()
          };
        });
        update(suggestionsRef, updates);
      }

      // Migrate Active List too if it exists locally
      const savedActive = localStorage.getItem('activeShoppingList');
      if (savedActive) {
        try {
          const localList = JSON.parse(savedActive);
          localList.forEach(item => {
            push(listRef, { name: item.name, store: item.store, checked: item.checked });
          });
          // Clear local storage to avoid re-migrating? Or just leave it.
          localStorage.removeItem('activeShoppingList');
        } catch (e) { }
      }
    }

    // --- ACTIONS (Write to Firebase) ---

    window.addItem = function (itemName, storeName) {
      if (!currentUser) return;
      if (!itemName.trim() || !storeName.trim()) return;
      itemName = itemName.trim();
      storeName = storeName.trim();

      // Check for duplicate in active list
      const exists = window.activeList.some(i => i.name.toLowerCase() === itemName.toLowerCase() && i.store === storeName);
      if (exists) {
        alert(`"${itemName}" is already in your list!`);
        return;
      }

      push(listRef, { name: itemName, store: storeName, checked: false });
      updateItemStats(itemName, storeName);
    };

    window.updateItemStats = function (itemName, storeName) {
      // Since we can't easily query exact key, we construct a path or update based on known logic
      // Simplest: just update the specific item path in suggestions
      const updates = {};
      const current = window.suggestionDB[itemName];

      if (!current) {
        updates[itemName] = {
          store: storeName,
          count: 1,
          lastUsed: Date.now()
        };
      } else {
        updates[itemName] = {
          store: storeName,
          count: current.count + 1,
          lastUsed: Date.now()
        };
      }
      update(suggestionsRef, updates);
    };

    window.removeItem = function (id) {
       if (!currentUser) return;
      remove(ref(db, `users/${currentUser.uid}/shoppingList/${id}`));
    };

    window.toggleItem = function (id, currentStatus) {
       if (!currentUser) return;
      update(ref(db, `users/${currentUser.uid}/shoppingList/${id}`), { checked: !currentStatus });
    };

    window.clearChecked = function () {
       if (!currentUser) return;
      // Find all checked items and remove them
      // This is not atomic, but fine for personal app.
      // Better: Create a 'updates' object to set null for all paths
      const updates = {};
      window.activeList.forEach(item => {
        if (item.checked) {
          updates[`users/${currentUser.uid}/shoppingList/${item.id}`] = null;
        }
      });
      if (Object.keys(updates).length > 0) update(ref(db), updates);
    };

    window.clearAll = function () {
       if (!currentUser) return;
      if (window.confirm('Are you sure you want to delete ALL items from the list?')) {
        set(listRef, null);
      }
    };

    // Custom Store Add
    window.addCustomStore = function (storeName) {
      if (!currentUser) return;
      if (!window.storeIcons[storeName]) {
        const updates = {};
        updates[storeName] = { emoji: 'üõçÔ∏è', color: '#6b7280' };
        update(iconsRef, updates);
      }
    }

    // --- RENDERING (Only slight mods needed for IDs) ---
    // We attach these to window so HTML onclicks work
    window.renderAll = function () {
      renderActiveList();
      renderSuggestions();
    };

    window.renderActiveList = function () {
      const container = document.getElementById('activeListContainer');

      if (window.activeList.length === 0) {
        container.innerHTML = '<div class="active-list-empty">Your list is empty. Add items above to get started.</div>';
        return;
      }

      // Group by store
      const byStore = {};
      window.activeList.forEach((item) => {
        if (!byStore[item.store]) byStore[item.store] = [];
        byStore[item.store].push(item);
      });

      let html = '<div class="active-list">';
      Object.keys(byStore).sort().forEach(storeName => {
        const icon = window.getStoreIcon(storeName);
        html += `
          <div class="store-group">
            <div class="store-group-header">
              <div class="store-group-icon" style="background: ${icon.color}">${icon.emoji}</div>
              <div class="store-group-name">${storeName}</div>
            </div>
            <div class="active-items-grid">
        `;

        byStore[storeName].forEach(item => {
          html += `
            <div class="item active-item">
              <label>
                <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItem('${item.id}', ${item.checked})"/>
                <div class="checkmark"><svg viewBox="0 0 12 12" fill="none" stroke="#fff" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6.5L5 9.5L10 3"/></svg></div>
                <span class="item-label">${item.name}</span>
              </label>
              <button class="delete-btn" onclick="removeItem('${item.id}')">Delete</button>
            </div>
          `;
        });
        html += '</div></div>';
      });
      html += '</div>';
      container.innerHTML = html;
    };

    window.renderSuggestions = function () {
      const container = document.getElementById('suggestionsContainer');
      const activeNames = new Set(window.activeList.map(i => i.name));

      let candidates = Object.entries(window.suggestionDB).map(([name, data]) => ({
        name: name,
        ...data
      }));

      // Filter out active items
      candidates = candidates.filter(item => !activeNames.has(item.name));

      // SMART SORT
      candidates.sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return b.lastUsed - a.lastUsed;
      });

      const topSuggestions = candidates.slice(0, 50);

      if (topSuggestions.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">No suggestions available. Add new items above and I'll remember them!</div>`;
        return;
      }

      const byStore = {};
      topSuggestions.forEach(item => {
        if (!byStore[item.store]) byStore[item.store] = [];
        byStore[item.store].push(item);
      });

      let html = '';
      Object.keys(byStore).sort().forEach(storeName => {
        const icon = window.getStoreIcon(storeName);
        html += `
          <div class="store-section">
            <div class="store-header">
              <div class="store-icon" style="background: ${icon.color}">${icon.emoji}</div>
              <div>
                <h2>${storeName}</h2>
                <div class="item-count">${byStore[storeName].length} suggestions</div>
              </div>
            </div>
            <div class="suggestions-grid">
        `;

        byStore[storeName].forEach(item => {
          html += `
            <div class="item suggestion-item" onclick="addItem('${item.name.replace(/'/g, "\\'")}', '${item.store.replace(/'/g, "\\'")}')">
              <div class="item-label">${item.name}</div>
              <div class="suggestion-icon">+</div>
            </div>
          `;
        });
        html += '</div></div>';
      });
      container.innerHTML = html;
    };


    // --- EVENT LISTENERS ---
    window.addEventListener('DOMContentLoaded', function () {
      // Firebase listeners handle data loading and render
      // renderAll() will be called when onValue triggers
      // We set up the form submit listener here
      const form = document.querySelector('.add-item-form');
      const itemInput = document.getElementById('newItemInput');
      const storeSelect = document.getElementById('storeSelect');
      const newStoreInput = document.getElementById('newStoreInput');

      // Populate Store Select
      const updateStoreSelect = () => {
        const stores = Object.keys(window.storeIcons).sort();
        // Custom sort order logic
        const priority = ['Trader Joe\'s', 'Costco', 'Amazon'];
        stores.sort((a, b) => {
          const idxA = priority.indexOf(a);
          const idxB = priority.indexOf(b);
          if (idxA !== -1 && idxB !== -1) return idxA - idxB;
          if (idxA !== -1) return -1;
          if (idxB !== -1) return 1;
          return a.localeCompare(b);
        });

        // Current selection
        const currentVal = storeSelect.value;
        storeSelect.innerHTML = stores.map(s => `<option value="${s}">${s}</option>`).join('');
        storeSelect.innerHTML += '<option value="Other">Other...</option>';

        if (currentVal && stores.includes(currentVal)) {
          storeSelect.value = currentVal;
        } else if (currentVal === 'Other') {
          storeSelect.value = 'Other';
        } else {
          storeSelect.value = "Trader Joe's"; // Default if not found
        }
      };
      updateStoreSelect();

      // Handle "Other" store
      storeSelect.addEventListener('change', function () {
        if (this.value === 'Other') {
          newStoreInput.style.display = 'block';
          newStoreInput.focus();
        } else {
          newStoreInput.style.display = 'none';
        }
      });

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const item = itemInput.value;
        let store = storeSelect.value;
        if (store === 'Other') {
          store = newStoreInput.value;
          if (store && !window.storeIcons[store]) {
            window.addCustomStore(store);
          }
        }
        if (item && store) {
          window.addItem(item, store);
          itemInput.value = '';
          // Reset store logic if desired, or keep last used
          if (storeSelect.value === 'Other') {
             storeSelect.value = "Trader Joe's";
             newStoreInput.style.display = 'none';
             newStoreInput.value = '';
          }
        }
      });
    });
  </script>
</head>

<body>
  <div id="loginOverlay">
    <div class="login-box">
      <h1 style="color:#d4850f; margin-bottom:10px;">Shopping List</h1>
      <p style="color:#5a6070; margin-bottom:24px;">Sign in to sync your items across devices.</p>
      <button class="login-btn" onclick="login()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"></path><path fill="#fff" d="M9 18c2.43 0 4.467-.806 5.956-2.180l-2.908-2.259c-.806.54-1.836.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 1 9 18z" opacity=".2"></path><path fill="#fff" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" opacity=".4"></path><path fill="#fff" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 1 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z" opacity=".2"></path></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div id="userHeader" class="user-header" style="display:none;"></div>


  <div class="header">
    <h1>Chris' <span class="highlight">Shopping List</span></h1>
    <p>Smart, synced, and organized.</p>
  </div>

  <div class="add-item-section">
    <h3>Add New Item</h3>
    <form class="add-item-form">
      <div class="add-item-row">
        <input type="text" id="newItemInput" placeholder="What do you need?" required />
        <select id="storeSelect">
          <!-- Populated by JS -->
        </select>
      </div>
      <input type="text" id="newStoreInput" placeholder="Enter store name..." style="display:none;" />
      <button type="submit">Add to List</button>
    </form>
  </div>

  <div id="activeListContainer">
    <!-- Active items go here -->
  </div>

  <div class="divider">
    <span>Suggested For You</span>
  </div>

  <div id="suggestionsContainer">
    <!-- Suggestions go here -->
  </div>

  <div class="action-buttons">
    <button onclick="clearChecked()">Clear Checked</button>
    <button class="danger" onclick="clearAll()">Delete All</button>
  </div>
</body>

</html>